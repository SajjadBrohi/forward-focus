{"ast":null,"code":"\"use strict\";\n/**\n * Copyright 2019 Google Inc. All rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.DOMWorld = void 0;\n\nconst assert_js_1 = require(\"./assert.js\");\n\nconst helper_js_1 = require(\"./helper.js\");\n\nconst LifecycleWatcher_js_1 = require(\"./LifecycleWatcher.js\");\n\nconst Errors_js_1 = require(\"./Errors.js\");\n\nconst QueryHandler_js_1 = require(\"./QueryHandler.js\");\n\nconst environment_js_1 = require(\"../environment.js\");\n/**\n * @internal\n */\n\n\nclass DOMWorld {\n  constructor(frameManager, frame, timeoutSettings) {\n    this._documentPromise = null;\n    this._contextPromise = null;\n    this._contextResolveCallback = null;\n    this._detached = false;\n    /**\n     * internal\n     */\n\n    this._waitTasks = new Set();\n    this._frameManager = frameManager;\n    this._frame = frame;\n    this._timeoutSettings = timeoutSettings;\n\n    this._setContext(null);\n  }\n\n  frame() {\n    return this._frame;\n  }\n\n  _setContext(context) {\n    if (context) {\n      this._contextResolveCallback.call(null, context);\n\n      this._contextResolveCallback = null;\n\n      for (const waitTask of this._waitTasks) waitTask.rerun();\n    } else {\n      this._documentPromise = null;\n      this._contextPromise = new Promise(fulfill => {\n        this._contextResolveCallback = fulfill;\n      });\n    }\n  }\n\n  _hasContext() {\n    return !this._contextResolveCallback;\n  }\n\n  _detach() {\n    this._detached = true;\n\n    for (const waitTask of this._waitTasks) waitTask.terminate(new Error('waitForFunction failed: frame got detached.'));\n  }\n\n  executionContext() {\n    if (this._detached) throw new Error(`Execution Context is not available in detached frame \"${this._frame.url()}\" (are you trying to evaluate?)`);\n    return this._contextPromise;\n  }\n\n  async evaluateHandle(pageFunction, ...args) {\n    const context = await this.executionContext();\n    return context.evaluateHandle(pageFunction, ...args);\n  }\n\n  async evaluate(pageFunction, ...args) {\n    const context = await this.executionContext();\n    return context.evaluate(pageFunction, ...args);\n  }\n\n  async $(selector) {\n    const document = await this._document();\n    const value = await document.$(selector);\n    return value;\n  }\n\n  async _document() {\n    if (this._documentPromise) return this._documentPromise;\n    this._documentPromise = this.executionContext().then(async context => {\n      const document = await context.evaluateHandle('document');\n      return document.asElement();\n    });\n    return this._documentPromise;\n  }\n\n  async $x(expression) {\n    const document = await this._document();\n    const value = await document.$x(expression);\n    return value;\n  }\n\n  async $eval(selector, pageFunction, ...args) {\n    const document = await this._document();\n    return document.$eval(selector, pageFunction, ...args);\n  }\n\n  async $$eval(selector, pageFunction, ...args) {\n    const document = await this._document();\n    const value = await document.$$eval(selector, pageFunction, ...args);\n    return value;\n  }\n\n  async $$(selector) {\n    const document = await this._document();\n    const value = await document.$$(selector);\n    return value;\n  }\n\n  async content() {\n    return await this.evaluate(() => {\n      let retVal = '';\n      if (document.doctype) retVal = new XMLSerializer().serializeToString(document.doctype);\n      if (document.documentElement) retVal += document.documentElement.outerHTML;\n      return retVal;\n    });\n  }\n\n  async setContent(html, options = {}) {\n    const {\n      waitUntil = ['load'],\n      timeout = this._timeoutSettings.navigationTimeout()\n    } = options; // We rely upon the fact that document.open() will reset frame lifecycle with \"init\"\n    // lifecycle event. @see https://crrev.com/608658\n\n    await this.evaluate(html => {\n      document.open();\n      document.write(html);\n      document.close();\n    }, html);\n    const watcher = new LifecycleWatcher_js_1.LifecycleWatcher(this._frameManager, this._frame, waitUntil, timeout);\n    const error = await Promise.race([watcher.timeoutOrTerminationPromise(), watcher.lifecyclePromise()]);\n    watcher.dispose();\n    if (error) throw error;\n  }\n  /**\n   * Adds a script tag into the current context.\n   *\n   * @remarks\n   *\n   * You can pass a URL, filepath or string of contents. Note that when running Puppeteer\n   * in a browser environment you cannot pass a filepath and should use either\n   * `url` or `content`.\n   */\n\n\n  async addScriptTag(options) {\n    const {\n      url = null,\n      path = null,\n      content = null,\n      type = ''\n    } = options;\n\n    if (url !== null) {\n      try {\n        const context = await this.executionContext();\n        return (await context.evaluateHandle(addScriptUrl, url, type)).asElement();\n      } catch (error) {\n        throw new Error(`Loading script from ${url} failed`);\n      }\n    }\n\n    if (path !== null) {\n      if (!environment_js_1.isNode) {\n        throw new Error('Cannot pass a filepath to addScriptTag in the browser environment.');\n      } // eslint-disable-next-line @typescript-eslint/no-var-requires\n\n\n      const fs = require('fs'); // eslint-disable-next-line @typescript-eslint/no-var-requires\n\n\n      const {\n        promisify\n      } = require('util');\n\n      const readFileAsync = promisify(fs.readFile);\n      let contents = await readFileAsync(path, 'utf8');\n      contents += '//# sourceURL=' + path.replace(/\\n/g, '');\n      const context = await this.executionContext();\n      return (await context.evaluateHandle(addScriptContent, contents, type)).asElement();\n    }\n\n    if (content !== null) {\n      const context = await this.executionContext();\n      return (await context.evaluateHandle(addScriptContent, content, type)).asElement();\n    }\n\n    throw new Error('Provide an object with a `url`, `path` or `content` property');\n\n    async function addScriptUrl(url, type) {\n      const script = document.createElement('script');\n      script.src = url;\n      if (type) script.type = type;\n      const promise = new Promise((res, rej) => {\n        script.onload = res;\n        script.onerror = rej;\n      });\n      document.head.appendChild(script);\n      await promise;\n      return script;\n    }\n\n    function addScriptContent(content, type = 'text/javascript') {\n      const script = document.createElement('script');\n      script.type = type;\n      script.text = content;\n      let error = null;\n\n      script.onerror = e => error = e;\n\n      document.head.appendChild(script);\n      if (error) throw error;\n      return script;\n    }\n  }\n  /**\n   * Adds a style tag into the current context.\n   *\n   * @remarks\n   *\n   * You can pass a URL, filepath or string of contents. Note that when running Puppeteer\n   * in a browser environment you cannot pass a filepath and should use either\n   * `url` or `content`.\n   *\n   */\n\n\n  async addStyleTag(options) {\n    const {\n      url = null,\n      path = null,\n      content = null\n    } = options;\n\n    if (url !== null) {\n      try {\n        const context = await this.executionContext();\n        return (await context.evaluateHandle(addStyleUrl, url)).asElement();\n      } catch (error) {\n        throw new Error(`Loading style from ${url} failed`);\n      }\n    }\n\n    if (path !== null) {\n      if (!environment_js_1.isNode) {\n        throw new Error('Cannot pass a filepath to addStyleTag in the browser environment.');\n      } // eslint-disable-next-line @typescript-eslint/no-var-requires\n\n\n      const fs = require('fs'); // eslint-disable-next-line @typescript-eslint/no-var-requires\n\n\n      const {\n        promisify\n      } = require('util');\n\n      const readFileAsync = promisify(fs.readFile);\n      let contents = await readFileAsync(path, 'utf8');\n      contents += '/*# sourceURL=' + path.replace(/\\n/g, '') + '*/';\n      const context = await this.executionContext();\n      return (await context.evaluateHandle(addStyleContent, contents)).asElement();\n    }\n\n    if (content !== null) {\n      const context = await this.executionContext();\n      return (await context.evaluateHandle(addStyleContent, content)).asElement();\n    }\n\n    throw new Error('Provide an object with a `url`, `path` or `content` property');\n\n    async function addStyleUrl(url) {\n      const link = document.createElement('link');\n      link.rel = 'stylesheet';\n      link.href = url;\n      const promise = new Promise((res, rej) => {\n        link.onload = res;\n        link.onerror = rej;\n      });\n      document.head.appendChild(link);\n      await promise;\n      return link;\n    }\n\n    async function addStyleContent(content) {\n      const style = document.createElement('style');\n      style.type = 'text/css';\n      style.appendChild(document.createTextNode(content));\n      const promise = new Promise((res, rej) => {\n        style.onload = res;\n        style.onerror = rej;\n      });\n      document.head.appendChild(style);\n      await promise;\n      return style;\n    }\n  }\n\n  async click(selector, options) {\n    const handle = await this.$(selector);\n    assert_js_1.assert(handle, 'No node found for selector: ' + selector);\n    await handle.click(options);\n    await handle.dispose();\n  }\n\n  async focus(selector) {\n    const handle = await this.$(selector);\n    assert_js_1.assert(handle, 'No node found for selector: ' + selector);\n    await handle.focus();\n    await handle.dispose();\n  }\n\n  async hover(selector) {\n    const handle = await this.$(selector);\n    assert_js_1.assert(handle, 'No node found for selector: ' + selector);\n    await handle.hover();\n    await handle.dispose();\n  }\n\n  async select(selector, ...values) {\n    const handle = await this.$(selector);\n    assert_js_1.assert(handle, 'No node found for selector: ' + selector);\n    const result = await handle.select(...values);\n    await handle.dispose();\n    return result;\n  }\n\n  async tap(selector) {\n    const handle = await this.$(selector);\n    assert_js_1.assert(handle, 'No node found for selector: ' + selector);\n    await handle.tap();\n    await handle.dispose();\n  }\n\n  async type(selector, text, options) {\n    const handle = await this.$(selector);\n    assert_js_1.assert(handle, 'No node found for selector: ' + selector);\n    await handle.type(text, options);\n    await handle.dispose();\n  }\n\n  waitForSelector(selector, options) {\n    return this._waitForSelectorOrXPath(selector, false, options);\n  }\n\n  waitForXPath(xpath, options) {\n    return this._waitForSelectorOrXPath(xpath, true, options);\n  }\n\n  waitForFunction(pageFunction, options = {}, ...args) {\n    const {\n      polling = 'raf',\n      timeout = this._timeoutSettings.timeout()\n    } = options;\n    return new WaitTask(this, pageFunction, undefined, 'function', polling, timeout, ...args).promise;\n  }\n\n  async title() {\n    return this.evaluate(() => document.title);\n  }\n\n  async _waitForSelectorOrXPath(selectorOrXPath, isXPath, options = {}) {\n    const {\n      visible: waitForVisible = false,\n      hidden: waitForHidden = false,\n      timeout = this._timeoutSettings.timeout()\n    } = options;\n    const polling = waitForVisible || waitForHidden ? 'raf' : 'mutation';\n    const title = `${isXPath ? 'XPath' : 'selector'} \"${selectorOrXPath}\"${waitForHidden ? ' to be hidden' : ''}`;\n    const {\n      updatedSelector,\n      queryHandler\n    } = QueryHandler_js_1.getQueryHandlerAndSelector(selectorOrXPath);\n    const waitTask = new WaitTask(this, predicate, queryHandler.queryOne, title, polling, timeout, updatedSelector, isXPath, waitForVisible, waitForHidden);\n    const handle = await waitTask.promise;\n\n    if (!handle.asElement()) {\n      await handle.dispose();\n      return null;\n    }\n\n    return handle.asElement();\n\n    function predicate(selectorOrXPath, isXPath, waitForVisible, waitForHidden) {\n      const node = isXPath ? document.evaluate(selectorOrXPath, document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue : predicateQueryHandler ? predicateQueryHandler(document, selectorOrXPath) : document.querySelector(selectorOrXPath);\n      if (!node) return waitForHidden;\n      if (!waitForVisible && !waitForHidden) return node;\n      const element = node.nodeType === Node.TEXT_NODE ? node.parentElement : node;\n      const style = window.getComputedStyle(element);\n      const isVisible = style && style.visibility !== 'hidden' && hasVisibleBoundingBox();\n      const success = waitForVisible === isVisible || waitForHidden === !isVisible;\n      return success ? node : null;\n\n      function hasVisibleBoundingBox() {\n        const rect = element.getBoundingClientRect();\n        return !!(rect.top || rect.bottom || rect.width || rect.height);\n      }\n    }\n  }\n\n}\n\nexports.DOMWorld = DOMWorld;\n\nclass WaitTask {\n  constructor(domWorld, predicateBody, predicateQueryHandlerBody, title, polling, timeout, ...args) {\n    this._runCount = 0;\n    this._terminated = false;\n    if (helper_js_1.helper.isString(polling)) assert_js_1.assert(polling === 'raf' || polling === 'mutation', 'Unknown polling option: ' + polling);else if (helper_js_1.helper.isNumber(polling)) assert_js_1.assert(polling > 0, 'Cannot poll with non-positive interval: ' + polling);else throw new Error('Unknown polling options: ' + polling);\n\n    function getPredicateBody(predicateBody, predicateQueryHandlerBody) {\n      if (helper_js_1.helper.isString(predicateBody)) return `return (${predicateBody});`;\n\n      if (predicateQueryHandlerBody) {\n        return `\n          return (function wrapper(args) {\n            const predicateQueryHandler = ${predicateQueryHandlerBody};\n            return (${predicateBody})(...args);\n          })(args);`;\n      }\n\n      return `return (${predicateBody})(...args);`;\n    }\n\n    this._domWorld = domWorld;\n    this._polling = polling;\n    this._timeout = timeout;\n    this._predicateBody = getPredicateBody(predicateBody, predicateQueryHandlerBody);\n    this._args = args;\n    this._runCount = 0;\n\n    domWorld._waitTasks.add(this);\n\n    this.promise = new Promise((resolve, reject) => {\n      this._resolve = resolve;\n      this._reject = reject;\n    }); // Since page navigation requires us to re-install the pageScript, we should track\n    // timeout on our end.\n\n    if (timeout) {\n      const timeoutError = new Errors_js_1.TimeoutError(`waiting for ${title} failed: timeout ${timeout}ms exceeded`);\n      this._timeoutTimer = setTimeout(() => this.terminate(timeoutError), timeout);\n    }\n\n    this.rerun();\n  }\n\n  terminate(error) {\n    this._terminated = true;\n\n    this._reject(error);\n\n    this._cleanup();\n  }\n\n  async rerun() {\n    const runCount = ++this._runCount;\n    /** @type {?JSHandle} */\n\n    let success = null;\n    let error = null;\n\n    try {\n      success = await (await this._domWorld.executionContext()).evaluateHandle(waitForPredicatePageFunction, this._predicateBody, this._polling, this._timeout, ...this._args);\n    } catch (error_) {\n      error = error_;\n    }\n\n    if (this._terminated || runCount !== this._runCount) {\n      if (success) await success.dispose();\n      return;\n    } // Ignore timeouts in pageScript - we track timeouts ourselves.\n    // If the frame's execution context has already changed, `frame.evaluate` will\n    // throw an error - ignore this predicate run altogether.\n\n\n    if (!error && (await this._domWorld.evaluate(s => !s, success).catch(() => true))) {\n      await success.dispose();\n      return;\n    } // When the page is navigated, the promise is rejected.\n    // We will try again in the new execution context.\n\n\n    if (error && error.message.includes('Execution context was destroyed')) return; // We could have tried to evaluate in a context which was already\n    // destroyed.\n\n    if (error && error.message.includes('Cannot find context with specified id')) return;\n    if (error) this._reject(error);else this._resolve(success);\n\n    this._cleanup();\n  }\n\n  _cleanup() {\n    clearTimeout(this._timeoutTimer);\n\n    this._domWorld._waitTasks.delete(this);\n  }\n\n}\n\nasync function waitForPredicatePageFunction(predicateBody, polling, timeout, ...args) {\n  const predicate = new Function('...args', predicateBody);\n  let timedOut = false;\n  if (timeout) setTimeout(() => timedOut = true, timeout);\n  if (polling === 'raf') return await pollRaf();\n  if (polling === 'mutation') return await pollMutation();\n  if (typeof polling === 'number') return await pollInterval(polling);\n  /**\n   * @returns {!Promise<*>}\n   */\n\n  async function pollMutation() {\n    const success = await predicate(...args);\n    if (success) return Promise.resolve(success);\n    let fulfill;\n    const result = new Promise(x => fulfill = x);\n    const observer = new MutationObserver(async () => {\n      if (timedOut) {\n        observer.disconnect();\n        fulfill();\n      }\n\n      const success = await predicate(...args);\n\n      if (success) {\n        observer.disconnect();\n        fulfill(success);\n      }\n    });\n    observer.observe(document, {\n      childList: true,\n      subtree: true,\n      attributes: true\n    });\n    return result;\n  }\n\n  async function pollRaf() {\n    let fulfill;\n    const result = new Promise(x => fulfill = x);\n    await onRaf();\n    return result;\n\n    async function onRaf() {\n      if (timedOut) {\n        fulfill();\n        return;\n      }\n\n      const success = await predicate(...args);\n      if (success) fulfill(success);else requestAnimationFrame(onRaf);\n    }\n  }\n\n  async function pollInterval(pollInterval) {\n    let fulfill;\n    const result = new Promise(x => fulfill = x);\n    await onTimeout();\n    return result;\n\n    async function onTimeout() {\n      if (timedOut) {\n        fulfill();\n        return;\n      }\n\n      const success = await predicate(...args);\n      if (success) fulfill(success);else setTimeout(onTimeout, pollInterval);\n    }\n  }\n}","map":{"version":3,"sources":["C:/Users/Sajjad Brohi/JavaScript Projects/RESTful API/packages/client/node_modules/puppeteer/lib/cjs/puppeteer/common/DOMWorld.js"],"names":["Object","defineProperty","exports","value","DOMWorld","assert_js_1","require","helper_js_1","LifecycleWatcher_js_1","Errors_js_1","QueryHandler_js_1","environment_js_1","constructor","frameManager","frame","timeoutSettings","_documentPromise","_contextPromise","_contextResolveCallback","_detached","_waitTasks","Set","_frameManager","_frame","_timeoutSettings","_setContext","context","call","waitTask","rerun","Promise","fulfill","_hasContext","_detach","terminate","Error","executionContext","url","evaluateHandle","pageFunction","args","evaluate","$","selector","document","_document","then","asElement","$x","expression","$eval","$$eval","$$","content","retVal","doctype","XMLSerializer","serializeToString","documentElement","outerHTML","setContent","html","options","waitUntil","timeout","navigationTimeout","open","write","close","watcher","LifecycleWatcher","error","race","timeoutOrTerminationPromise","lifecyclePromise","dispose","addScriptTag","path","type","addScriptUrl","isNode","fs","promisify","readFileAsync","readFile","contents","replace","addScriptContent","script","createElement","src","promise","res","rej","onload","onerror","head","appendChild","text","e","addStyleTag","addStyleUrl","addStyleContent","link","rel","href","style","createTextNode","click","handle","assert","focus","hover","select","values","result","tap","waitForSelector","_waitForSelectorOrXPath","waitForXPath","xpath","waitForFunction","polling","WaitTask","undefined","title","selectorOrXPath","isXPath","visible","waitForVisible","hidden","waitForHidden","updatedSelector","queryHandler","getQueryHandlerAndSelector","predicate","queryOne","node","XPathResult","FIRST_ORDERED_NODE_TYPE","singleNodeValue","predicateQueryHandler","querySelector","element","nodeType","Node","TEXT_NODE","parentElement","window","getComputedStyle","isVisible","visibility","hasVisibleBoundingBox","success","rect","getBoundingClientRect","top","bottom","width","height","domWorld","predicateBody","predicateQueryHandlerBody","_runCount","_terminated","helper","isString","isNumber","getPredicateBody","_domWorld","_polling","_timeout","_predicateBody","_args","add","resolve","reject","_resolve","_reject","timeoutError","TimeoutError","_timeoutTimer","setTimeout","_cleanup","runCount","waitForPredicatePageFunction","error_","s","catch","message","includes","clearTimeout","delete","Function","timedOut","pollRaf","pollMutation","pollInterval","x","observer","MutationObserver","disconnect","observe","childList","subtree","attributes","onRaf","requestAnimationFrame","onTimeout"],"mappings":"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","sourcesContent":["\"use strict\";\n/**\n * Copyright 2019 Google Inc. All rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.DOMWorld = void 0;\nconst assert_js_1 = require(\"./assert.js\");\nconst helper_js_1 = require(\"./helper.js\");\nconst LifecycleWatcher_js_1 = require(\"./LifecycleWatcher.js\");\nconst Errors_js_1 = require(\"./Errors.js\");\nconst QueryHandler_js_1 = require(\"./QueryHandler.js\");\nconst environment_js_1 = require(\"../environment.js\");\n/**\n * @internal\n */\nclass DOMWorld {\n    constructor(frameManager, frame, timeoutSettings) {\n        this._documentPromise = null;\n        this._contextPromise = null;\n        this._contextResolveCallback = null;\n        this._detached = false;\n        /**\n         * internal\n         */\n        this._waitTasks = new Set();\n        this._frameManager = frameManager;\n        this._frame = frame;\n        this._timeoutSettings = timeoutSettings;\n        this._setContext(null);\n    }\n    frame() {\n        return this._frame;\n    }\n    _setContext(context) {\n        if (context) {\n            this._contextResolveCallback.call(null, context);\n            this._contextResolveCallback = null;\n            for (const waitTask of this._waitTasks)\n                waitTask.rerun();\n        }\n        else {\n            this._documentPromise = null;\n            this._contextPromise = new Promise((fulfill) => {\n                this._contextResolveCallback = fulfill;\n            });\n        }\n    }\n    _hasContext() {\n        return !this._contextResolveCallback;\n    }\n    _detach() {\n        this._detached = true;\n        for (const waitTask of this._waitTasks)\n            waitTask.terminate(new Error('waitForFunction failed: frame got detached.'));\n    }\n    executionContext() {\n        if (this._detached)\n            throw new Error(`Execution Context is not available in detached frame \"${this._frame.url()}\" (are you trying to evaluate?)`);\n        return this._contextPromise;\n    }\n    async evaluateHandle(pageFunction, ...args) {\n        const context = await this.executionContext();\n        return context.evaluateHandle(pageFunction, ...args);\n    }\n    async evaluate(pageFunction, ...args) {\n        const context = await this.executionContext();\n        return context.evaluate(pageFunction, ...args);\n    }\n    async $(selector) {\n        const document = await this._document();\n        const value = await document.$(selector);\n        return value;\n    }\n    async _document() {\n        if (this._documentPromise)\n            return this._documentPromise;\n        this._documentPromise = this.executionContext().then(async (context) => {\n            const document = await context.evaluateHandle('document');\n            return document.asElement();\n        });\n        return this._documentPromise;\n    }\n    async $x(expression) {\n        const document = await this._document();\n        const value = await document.$x(expression);\n        return value;\n    }\n    async $eval(selector, pageFunction, ...args) {\n        const document = await this._document();\n        return document.$eval(selector, pageFunction, ...args);\n    }\n    async $$eval(selector, pageFunction, ...args) {\n        const document = await this._document();\n        const value = await document.$$eval(selector, pageFunction, ...args);\n        return value;\n    }\n    async $$(selector) {\n        const document = await this._document();\n        const value = await document.$$(selector);\n        return value;\n    }\n    async content() {\n        return await this.evaluate(() => {\n            let retVal = '';\n            if (document.doctype)\n                retVal = new XMLSerializer().serializeToString(document.doctype);\n            if (document.documentElement)\n                retVal += document.documentElement.outerHTML;\n            return retVal;\n        });\n    }\n    async setContent(html, options = {}) {\n        const { waitUntil = ['load'], timeout = this._timeoutSettings.navigationTimeout(), } = options;\n        // We rely upon the fact that document.open() will reset frame lifecycle with \"init\"\n        // lifecycle event. @see https://crrev.com/608658\n        await this.evaluate((html) => {\n            document.open();\n            document.write(html);\n            document.close();\n        }, html);\n        const watcher = new LifecycleWatcher_js_1.LifecycleWatcher(this._frameManager, this._frame, waitUntil, timeout);\n        const error = await Promise.race([\n            watcher.timeoutOrTerminationPromise(),\n            watcher.lifecyclePromise(),\n        ]);\n        watcher.dispose();\n        if (error)\n            throw error;\n    }\n    /**\n     * Adds a script tag into the current context.\n     *\n     * @remarks\n     *\n     * You can pass a URL, filepath or string of contents. Note that when running Puppeteer\n     * in a browser environment you cannot pass a filepath and should use either\n     * `url` or `content`.\n     */\n    async addScriptTag(options) {\n        const { url = null, path = null, content = null, type = '' } = options;\n        if (url !== null) {\n            try {\n                const context = await this.executionContext();\n                return (await context.evaluateHandle(addScriptUrl, url, type)).asElement();\n            }\n            catch (error) {\n                throw new Error(`Loading script from ${url} failed`);\n            }\n        }\n        if (path !== null) {\n            if (!environment_js_1.isNode) {\n                throw new Error('Cannot pass a filepath to addScriptTag in the browser environment.');\n            }\n            // eslint-disable-next-line @typescript-eslint/no-var-requires\n            const fs = require('fs');\n            // eslint-disable-next-line @typescript-eslint/no-var-requires\n            const { promisify } = require('util');\n            const readFileAsync = promisify(fs.readFile);\n            let contents = await readFileAsync(path, 'utf8');\n            contents += '//# sourceURL=' + path.replace(/\\n/g, '');\n            const context = await this.executionContext();\n            return (await context.evaluateHandle(addScriptContent, contents, type)).asElement();\n        }\n        if (content !== null) {\n            const context = await this.executionContext();\n            return (await context.evaluateHandle(addScriptContent, content, type)).asElement();\n        }\n        throw new Error('Provide an object with a `url`, `path` or `content` property');\n        async function addScriptUrl(url, type) {\n            const script = document.createElement('script');\n            script.src = url;\n            if (type)\n                script.type = type;\n            const promise = new Promise((res, rej) => {\n                script.onload = res;\n                script.onerror = rej;\n            });\n            document.head.appendChild(script);\n            await promise;\n            return script;\n        }\n        function addScriptContent(content, type = 'text/javascript') {\n            const script = document.createElement('script');\n            script.type = type;\n            script.text = content;\n            let error = null;\n            script.onerror = (e) => (error = e);\n            document.head.appendChild(script);\n            if (error)\n                throw error;\n            return script;\n        }\n    }\n    /**\n     * Adds a style tag into the current context.\n     *\n     * @remarks\n     *\n     * You can pass a URL, filepath or string of contents. Note that when running Puppeteer\n     * in a browser environment you cannot pass a filepath and should use either\n     * `url` or `content`.\n     *\n     */\n    async addStyleTag(options) {\n        const { url = null, path = null, content = null } = options;\n        if (url !== null) {\n            try {\n                const context = await this.executionContext();\n                return (await context.evaluateHandle(addStyleUrl, url)).asElement();\n            }\n            catch (error) {\n                throw new Error(`Loading style from ${url} failed`);\n            }\n        }\n        if (path !== null) {\n            if (!environment_js_1.isNode) {\n                throw new Error('Cannot pass a filepath to addStyleTag in the browser environment.');\n            }\n            // eslint-disable-next-line @typescript-eslint/no-var-requires\n            const fs = require('fs');\n            // eslint-disable-next-line @typescript-eslint/no-var-requires\n            const { promisify } = require('util');\n            const readFileAsync = promisify(fs.readFile);\n            let contents = await readFileAsync(path, 'utf8');\n            contents += '/*# sourceURL=' + path.replace(/\\n/g, '') + '*/';\n            const context = await this.executionContext();\n            return (await context.evaluateHandle(addStyleContent, contents)).asElement();\n        }\n        if (content !== null) {\n            const context = await this.executionContext();\n            return (await context.evaluateHandle(addStyleContent, content)).asElement();\n        }\n        throw new Error('Provide an object with a `url`, `path` or `content` property');\n        async function addStyleUrl(url) {\n            const link = document.createElement('link');\n            link.rel = 'stylesheet';\n            link.href = url;\n            const promise = new Promise((res, rej) => {\n                link.onload = res;\n                link.onerror = rej;\n            });\n            document.head.appendChild(link);\n            await promise;\n            return link;\n        }\n        async function addStyleContent(content) {\n            const style = document.createElement('style');\n            style.type = 'text/css';\n            style.appendChild(document.createTextNode(content));\n            const promise = new Promise((res, rej) => {\n                style.onload = res;\n                style.onerror = rej;\n            });\n            document.head.appendChild(style);\n            await promise;\n            return style;\n        }\n    }\n    async click(selector, options) {\n        const handle = await this.$(selector);\n        assert_js_1.assert(handle, 'No node found for selector: ' + selector);\n        await handle.click(options);\n        await handle.dispose();\n    }\n    async focus(selector) {\n        const handle = await this.$(selector);\n        assert_js_1.assert(handle, 'No node found for selector: ' + selector);\n        await handle.focus();\n        await handle.dispose();\n    }\n    async hover(selector) {\n        const handle = await this.$(selector);\n        assert_js_1.assert(handle, 'No node found for selector: ' + selector);\n        await handle.hover();\n        await handle.dispose();\n    }\n    async select(selector, ...values) {\n        const handle = await this.$(selector);\n        assert_js_1.assert(handle, 'No node found for selector: ' + selector);\n        const result = await handle.select(...values);\n        await handle.dispose();\n        return result;\n    }\n    async tap(selector) {\n        const handle = await this.$(selector);\n        assert_js_1.assert(handle, 'No node found for selector: ' + selector);\n        await handle.tap();\n        await handle.dispose();\n    }\n    async type(selector, text, options) {\n        const handle = await this.$(selector);\n        assert_js_1.assert(handle, 'No node found for selector: ' + selector);\n        await handle.type(text, options);\n        await handle.dispose();\n    }\n    waitForSelector(selector, options) {\n        return this._waitForSelectorOrXPath(selector, false, options);\n    }\n    waitForXPath(xpath, options) {\n        return this._waitForSelectorOrXPath(xpath, true, options);\n    }\n    waitForFunction(pageFunction, options = {}, ...args) {\n        const { polling = 'raf', timeout = this._timeoutSettings.timeout(), } = options;\n        return new WaitTask(this, pageFunction, undefined, 'function', polling, timeout, ...args).promise;\n    }\n    async title() {\n        return this.evaluate(() => document.title);\n    }\n    async _waitForSelectorOrXPath(selectorOrXPath, isXPath, options = {}) {\n        const { visible: waitForVisible = false, hidden: waitForHidden = false, timeout = this._timeoutSettings.timeout(), } = options;\n        const polling = waitForVisible || waitForHidden ? 'raf' : 'mutation';\n        const title = `${isXPath ? 'XPath' : 'selector'} \"${selectorOrXPath}\"${waitForHidden ? ' to be hidden' : ''}`;\n        const { updatedSelector, queryHandler } = QueryHandler_js_1.getQueryHandlerAndSelector(selectorOrXPath);\n        const waitTask = new WaitTask(this, predicate, queryHandler.queryOne, title, polling, timeout, updatedSelector, isXPath, waitForVisible, waitForHidden);\n        const handle = await waitTask.promise;\n        if (!handle.asElement()) {\n            await handle.dispose();\n            return null;\n        }\n        return handle.asElement();\n        function predicate(selectorOrXPath, isXPath, waitForVisible, waitForHidden) {\n            const node = isXPath\n                ? document.evaluate(selectorOrXPath, document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue\n                : predicateQueryHandler\n                    ? predicateQueryHandler(document, selectorOrXPath)\n                    : document.querySelector(selectorOrXPath);\n            if (!node)\n                return waitForHidden;\n            if (!waitForVisible && !waitForHidden)\n                return node;\n            const element = node.nodeType === Node.TEXT_NODE\n                ? node.parentElement\n                : node;\n            const style = window.getComputedStyle(element);\n            const isVisible = style && style.visibility !== 'hidden' && hasVisibleBoundingBox();\n            const success = waitForVisible === isVisible || waitForHidden === !isVisible;\n            return success ? node : null;\n            function hasVisibleBoundingBox() {\n                const rect = element.getBoundingClientRect();\n                return !!(rect.top || rect.bottom || rect.width || rect.height);\n            }\n        }\n    }\n}\nexports.DOMWorld = DOMWorld;\nclass WaitTask {\n    constructor(domWorld, predicateBody, predicateQueryHandlerBody, title, polling, timeout, ...args) {\n        this._runCount = 0;\n        this._terminated = false;\n        if (helper_js_1.helper.isString(polling))\n            assert_js_1.assert(polling === 'raf' || polling === 'mutation', 'Unknown polling option: ' + polling);\n        else if (helper_js_1.helper.isNumber(polling))\n            assert_js_1.assert(polling > 0, 'Cannot poll with non-positive interval: ' + polling);\n        else\n            throw new Error('Unknown polling options: ' + polling);\n        function getPredicateBody(predicateBody, predicateQueryHandlerBody) {\n            if (helper_js_1.helper.isString(predicateBody))\n                return `return (${predicateBody});`;\n            if (predicateQueryHandlerBody) {\n                return `\n          return (function wrapper(args) {\n            const predicateQueryHandler = ${predicateQueryHandlerBody};\n            return (${predicateBody})(...args);\n          })(args);`;\n            }\n            return `return (${predicateBody})(...args);`;\n        }\n        this._domWorld = domWorld;\n        this._polling = polling;\n        this._timeout = timeout;\n        this._predicateBody = getPredicateBody(predicateBody, predicateQueryHandlerBody);\n        this._args = args;\n        this._runCount = 0;\n        domWorld._waitTasks.add(this);\n        this.promise = new Promise((resolve, reject) => {\n            this._resolve = resolve;\n            this._reject = reject;\n        });\n        // Since page navigation requires us to re-install the pageScript, we should track\n        // timeout on our end.\n        if (timeout) {\n            const timeoutError = new Errors_js_1.TimeoutError(`waiting for ${title} failed: timeout ${timeout}ms exceeded`);\n            this._timeoutTimer = setTimeout(() => this.terminate(timeoutError), timeout);\n        }\n        this.rerun();\n    }\n    terminate(error) {\n        this._terminated = true;\n        this._reject(error);\n        this._cleanup();\n    }\n    async rerun() {\n        const runCount = ++this._runCount;\n        /** @type {?JSHandle} */\n        let success = null;\n        let error = null;\n        try {\n            success = await (await this._domWorld.executionContext()).evaluateHandle(waitForPredicatePageFunction, this._predicateBody, this._polling, this._timeout, ...this._args);\n        }\n        catch (error_) {\n            error = error_;\n        }\n        if (this._terminated || runCount !== this._runCount) {\n            if (success)\n                await success.dispose();\n            return;\n        }\n        // Ignore timeouts in pageScript - we track timeouts ourselves.\n        // If the frame's execution context has already changed, `frame.evaluate` will\n        // throw an error - ignore this predicate run altogether.\n        if (!error &&\n            (await this._domWorld.evaluate((s) => !s, success).catch(() => true))) {\n            await success.dispose();\n            return;\n        }\n        // When the page is navigated, the promise is rejected.\n        // We will try again in the new execution context.\n        if (error && error.message.includes('Execution context was destroyed'))\n            return;\n        // We could have tried to evaluate in a context which was already\n        // destroyed.\n        if (error &&\n            error.message.includes('Cannot find context with specified id'))\n            return;\n        if (error)\n            this._reject(error);\n        else\n            this._resolve(success);\n        this._cleanup();\n    }\n    _cleanup() {\n        clearTimeout(this._timeoutTimer);\n        this._domWorld._waitTasks.delete(this);\n    }\n}\nasync function waitForPredicatePageFunction(predicateBody, polling, timeout, ...args) {\n    const predicate = new Function('...args', predicateBody);\n    let timedOut = false;\n    if (timeout)\n        setTimeout(() => (timedOut = true), timeout);\n    if (polling === 'raf')\n        return await pollRaf();\n    if (polling === 'mutation')\n        return await pollMutation();\n    if (typeof polling === 'number')\n        return await pollInterval(polling);\n    /**\n     * @returns {!Promise<*>}\n     */\n    async function pollMutation() {\n        const success = await predicate(...args);\n        if (success)\n            return Promise.resolve(success);\n        let fulfill;\n        const result = new Promise((x) => (fulfill = x));\n        const observer = new MutationObserver(async () => {\n            if (timedOut) {\n                observer.disconnect();\n                fulfill();\n            }\n            const success = await predicate(...args);\n            if (success) {\n                observer.disconnect();\n                fulfill(success);\n            }\n        });\n        observer.observe(document, {\n            childList: true,\n            subtree: true,\n            attributes: true,\n        });\n        return result;\n    }\n    async function pollRaf() {\n        let fulfill;\n        const result = new Promise((x) => (fulfill = x));\n        await onRaf();\n        return result;\n        async function onRaf() {\n            if (timedOut) {\n                fulfill();\n                return;\n            }\n            const success = await predicate(...args);\n            if (success)\n                fulfill(success);\n            else\n                requestAnimationFrame(onRaf);\n        }\n    }\n    async function pollInterval(pollInterval) {\n        let fulfill;\n        const result = new Promise((x) => (fulfill = x));\n        await onTimeout();\n        return result;\n        async function onTimeout() {\n            if (timedOut) {\n                fulfill();\n                return;\n            }\n            const success = await predicate(...args);\n            if (success)\n                fulfill(success);\n            else\n                setTimeout(onTimeout, pollInterval);\n        }\n    }\n}\n"]},"metadata":{},"sourceType":"script"}